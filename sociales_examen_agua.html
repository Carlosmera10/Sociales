<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examen: El agua</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #f0f8ff;
            --correct-color: #28a745;
            --incorrect-color: #dc3545;
            --background-color: #f4f4f9;
            --text-color: #333;
            --border-radius: 10px;
            --box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        .header {
            text-align: center;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .header h1 {
            color: var(--primary-color);
            margin: 0;
        }
        .question-section {
            margin-bottom: 35px;
            padding: 20px;
            background-color: var(--secondary-color);
            border-radius: var(--border-radius);
            border-left: 5px solid var(--primary-color);
        }
        .question-section h2 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        .question {
            margin-bottom: 25px;
        }
        .question-text {
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        .options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .option {
            background-color: white;
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .option:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }
        .option.selected {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .option.correct {
            background-color: var(--correct-color);
            color: white;
            border-color: var(--correct-color);
        }
        .option.incorrect {
            background-color: var(--incorrect-color);
            color: white;
            border-color: var(--incorrect-color);
        }
        /* Drag and Drop Styles */
        .word-bank, .drop-zone {
            padding: 15px;
            margin-top: 10px;
            border-radius: var(--border-radius);
            min-height: 50px;
        }
        .word-bank {
            background-color: #e9ecef;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .word {
            background-color: white;
            padding: 8px 12px;
            border: 2px solid #ccc;
            border-radius: 8px;
            cursor: grab;
            user-select: none;
        }
        .word:active {
            cursor: grabbing;
        }
        .drop-zone {
            background-color: #f8f9fa;
            border: 2px dashed var(--primary-color);
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }
        .drop-zone.over {
            background-color: #d1e7ff;
        }
        .drop-zone .word {
            cursor: default;
        }
        .drop-zone.correct { border: 2px solid var(--correct-color); }
        .drop-zone.incorrect { border: 2px solid var(--incorrect-color); }

        /* Matching Styles */
        .matching-container { display: flex; justify-content: space-between; gap: 20px; }
        .column { width: 48%; }
        .match-item {
            background: white;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .match-item.selected { border-color: var(--primary-color); background-color: #d1e7ff; }
        .match-item.paired-correct { background-color: var(--correct-color); color: white; border-color: var(--correct-color); }
        .match-item.paired-incorrect { background-color: var(--incorrect-color); color: white; border-color: var(--incorrect-color); }
        .match-item.paired { cursor: default; opacity: 0.7; }

        /* Category Drag Styles */
        .category-container { display: flex; flex-wrap: wrap; justify-content: space-around; gap: 15px; margin-top: 15px; }
        .category-box { flex: 1; min-width: 200px; text-align: center; }
        .category-box h4 { margin-bottom: 10px; }
        .category-box .drop-zone { min-height: 100px; }


        .submit-btn {
            display: block;
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            background-color: var(--correct-color);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .submit-btn:hover {
            background-color: #218838;
        }
        .results {
            margin-top: 20px;
            padding: 20px;
            border-radius: var(--border-radius);
            text-align: center;
            font-size: 1.5em;
            display: none;
        }
        .results.show {
            display: block;
            background-color: var(--secondary-color);
        }
        .results p { margin: 5px 0; }
        .final-score { font-weight: bold; color: var(--primary-color); }
        .feedback-message { font-style: italic; margin-top: 10px; }
        .main-footer { text-align: center; margin-top: 20px; padding-top: 10px; border-top: 1px solid #ccc; }
        .main-footer a { text-decoration: none; color: var(--primary-color); font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìù Examen: El agua</h1>
            <p>¬°Demuestra lo que has aprendido sobre nuestro recurso m√°s valioso!</p>
        </div>
        <div class="content">
            <form id="quiz-form">
                
                <div class="question-section">
                    <h2>‚úèÔ∏è Rellena los huecos</h2>
                    <!-- Preguntas 1-7 -->
                    <div class="question" data-question-type="type-1"><div class="question-text">1. El conjunto de toda el agua de la Tierra (mares, r√≠os, lagos, hielo...) se llama _____.</div><div class="options" data-correct="Hidrosfera üíß"><div class="option">Atm√≥sfera üåç</div><div class="option">Hidrosfera üíß</div><div class="option">Geosfera üèûÔ∏è</div><div class="option">Biosfera üå±</div></div></div>
                    <div class="question" data-question-type="type-1"><div class="question-text">2. El paso del estado s√≥lido (hielo) a l√≠quido se llama _____.</div><div class="options" data-correct="Fusi√≥n üî•"><div class="option">Fusi√≥n üî•</div><div class="option">Evaporaci√≥n üí®</div><div class="option">Condensaci√≥n ‚òÅÔ∏è</div><div class="option">Solidificaci√≥n üßä</div></div></div>
                    <div class="question" data-question-type="type-1"><div class="question-text">3. Cuando el agua se calienta y pasa de l√≠quido a gaseoso, ocurre la _____.</div><div class="options" data-correct="Evaporaci√≥n üí®"><div class="option">Precipitaci√≥n üåßÔ∏è</div><div class="option">Fusi√≥n üî•</div><div class="option">Evaporaci√≥n üí®</div><div class="option">Condensaci√≥n ‚òÅÔ∏è</div></div></div>
                    <div class="question" data-question-type="type-1"><div class="question-text">4. El agua en estado _____ la encontramos en forma de hielo, nieve o granizo.</div><div class="options" data-correct="S√≥lido üßä"><div class="option">L√≠quido üíß</div><div class="option">S√≥lido üßä</div><div class="option">Gaseoso üí®</div><div class="option">Vaporoso ‚ô®Ô∏è</div></div></div>
                    <div class="question" data-question-type="type-1"><div class="question-text">5. Las acumulaciones de agua bajo tierra que forman r√≠os subterr√°neos se llaman _____.</div><div class="options" data-correct="Acu√≠feros  –ø–æ–¥–∑–µ–º–Ω—ã–π"><div class="option">Embalses üèûÔ∏è</div><div class="option">Lagos üõ∂</div><div class="option">Manantiales ‚õ≤</div><div class="option">Acu√≠feros  –ø–æ–¥–∑–µ–º–Ω—ã–π</div></div></div>
                    <div class="question" data-question-type="type-1"><div class="question-text">6. Las curvas muy pronunciadas que forma un r√≠o en su curso bajo se llaman _____.</div><div class="options" data-correct="Meandros"><div class="option">Meandros ÍµΩÏù¥</div><div class="option">Afluentes üèûÔ∏è</div><div class="option">Cauces üåä</div><div class="option">Barrancos ‚õ∞Ô∏è</div></div></div>
                    <div class="question" data-question-type="type-1"><div class="question-text">7. En las Islas Canarias, los cauces por donde discurre el agua despu√©s de lluvias torrenciales se llaman _____.</div><div class="options" data-correct="Barrancos"><div class="option">R√≠as üèûÔ∏è</div><div class="option">Torrentes üåä</div><div class="option">Barrancos ‚õ∞Ô∏è</div><div class="option">Acu√≠feros üíß</div></div></div>
                </div>

                <div class="question-section">
                    <h2>üîÑ Ordena los procesos</h2>
                    <!-- Preguntas 8-9 -->
                    <div class="question" data-question-type="drag-sort"><div class="question-text">8. Ordena las 4 fases principales del ciclo del agua.</div><div class="drop-zone" data-answer="Evaporaci√≥n ‚òÄÔ∏è Condensaci√≥n ‚òÅÔ∏è Precipitaci√≥n üåßÔ∏è Acumulaci√≥n üèûÔ∏è"></div><div class="word-bank"><div class="word" draggable="true">Precipitaci√≥n üåßÔ∏è</div><div class="word" draggable="true">Evaporaci√≥n ‚òÄÔ∏è</div><div class="word" draggable="true">Acumulaci√≥n üèûÔ∏è</div><div class="word" draggable="true">Condensaci√≥n ‚òÅÔ∏è</div></div></div>
                    <div class="question" data-question-type="drag-sort"><div class="question-text">9. Ordena los tramos del recorrido de un r√≠o desde que nace hasta que llega al mar.</div><div class="drop-zone" data-answer="Curso alto ‚õ∞Ô∏è Curso medio ‚ÜîÔ∏è Curso bajo üåä"></div><div class="word-bank"><div class="word" draggable="true">Curso medio ‚ÜîÔ∏è</div><div class="word" draggable="true">Curso bajo üåä</div><div class="word" draggable="true">Curso alto ‚õ∞Ô∏è</div></div></div>
                </div>
                
                <div class="question-section">
                    <h2>‚úÖ Verdadero o Falso ‚ùå</h2>
                    <!-- Preguntas 10-15 -->
                    <div class="question" data-question-type="type-1"><div class="question-text">10. La hidrosfera es el conjunto de toda el agua que hay en el planeta Tierra.</div><div class="options" data-correct="Verdadero ‚úÖ"><div class="option">Verdadero ‚úÖ</div><div class="option">Falso ‚ùå</div></div></div>
                    <div class="question" data-question-type="type-1"><div class="question-text">11. El agua en estado s√≥lido, como el hielo, se llama vapor de agua.</div><div class="options" data-correct="Falso ‚ùå"><div class="option">Verdadero ‚úÖ</div><div class="option">Falso ‚ùå</div></div></div>
                    <div class="question" data-question-type="type-1"><div class="question-text">12. El r√≠o Tajo es el m√°s largo de Espa√±a.</div><div class="options" data-correct="Verdadero ‚úÖ"><div class="option">Verdadero ‚úÖ</div><div class="option">Falso ‚ùå</div></div></div>
                    <div class="question" data-question-type="type-1"><div class="question-text">13. Toda el agua que existe en el planeta Tierra es potable (se puede beber).</div><div class="options" data-correct="Falso ‚ùå"><div class="option">Verdadero ‚úÖ</div><div class="option">Falso ‚ùå</div></div></div>
                    <div class="question" data-question-type="type-1"><div class="question-text">14. Los r√≠os de la vertiente cant√°brica son, por lo general, largos y de caudal irregular.</div><div class="options" data-correct="Falso ‚ùå"><div class="option">Verdadero ‚úÖ</div><div class="option">Falso ‚ùå</div></div></div>
                    <div class="question" data-question-type="type-1"><div class="question-text">15. Las mareas son producidas por la atracci√≥n gravitatoria que ejercen la Luna y el Sol.</div><div class="options" data-correct="Verdadero ‚úÖ"><div class="option">Verdadero ‚úÖ</div><div class="option">Falso ‚ùå</div></div></div>
                </div>

                <div class="question-section">
                    <h2>üéØ Test: Elige la correcta</h2>
                    <!-- Preguntas 16-20 -->
                    <div class="question" data-question-type="type-1"><div class="question-text">16. ¬øCu√°l es el estado m√°s abundante del agua en la Tierra?</div><div class="options" data-correct="L√≠quido üíß"><div class="option">L√≠quido üíß</div><div class="option">Gaseoso üí®</div><div class="option">S√≥lido üßä</div><div class="option">Plasma ‚ö°</div></div></div>
                    <div class="question" data-question-type="type-1"><div class="question-text">17. ¬øCu√°l es el r√≠o m√°s caudaloso de Espa√±a (el que m√°s agua lleva)?</div><div class="options" data-correct="Ebro üåä"><div class="option">Tajo üèûÔ∏è</div><div class="option">Duero üçá</div><div class="option">Ebro üåä</div><div class="option">Guadalquivir üçä</div></div></div>
                    <div class="question" data-question-type="type-1"><div class="question-text">18. ¬øC√≥mo se llama el cambio del estado l√≠quido al estado s√≥lido?</div><div class="options" data-correct="Solidificaci√≥n üßä"><div class="option">Fusi√≥n üî•</div><div class="option">Solidificaci√≥n üßä</div><div class="option">Evaporaci√≥n üí®</div><div class="option">Condensaci√≥n ‚òÅÔ∏è</div></div></div>
                    <div class="question" data-question-type="type-1"><div class="question-text">19. ¬øQu√© es un afluente?</div><div class="options" data-correct="Un r√≠o que desemboca en otro r√≠o m√°s grande."><div class="option">Un r√≠o que desemboca en el mar. üåä</div><div class="option">Un r√≠o que se seca en verano. ‚òÄÔ∏è</div><div class="option">Un r√≠o que desemboca en otro r√≠o m√°s grande. üèûÔ∏è</div><div class="option">La curva de un r√≠o. ÍµΩÏù¥</div></div></div>
                    <div class="question" data-question-type="type-1"><div class="question-text">20. El embalse m√°s grande de la Comunidad de Madrid es...</div><div class="options" data-correct="El Atazar"><div class="option">El de Santillana üè∞</div><div class="option">El de Valmayor üèûÔ∏è</div><div class="option">El Atazar üíß</div><div class="option">El Pardo ü¶å</div></div></div>
                </div>
                
                <div class="question-section">
                     <h2>‚òëÔ∏è Test: M√∫ltiples respuestas</h2>
                     <!-- Preguntas 21-24 -->
                     <div class="question" data-question-type="multiple-choice"><div class="question-text">21. Selecciona los TRES estados en los que podemos encontrar el agua.</div><div class="options multiple-choice" data-correct='["S√≥lido üßä","L√≠quido üíß","Gaseoso üí®"]'><div class="option">S√≥lido üßä</div><div class="option">Plasm√°tico ‚ö°</div><div class="option">L√≠quido üíß</div><div class="option">Gaseoso üí®</div></div></div>
                     <div class="question" data-question-type="multiple-choice"><div class="question-text">22. Selecciona dos r√≠os que pasen por la Comunidad de Madrid.</div><div class="options multiple-choice" data-correct='["R√≠o Jarama üèûÔ∏è","R√≠o Manzanares üèôÔ∏è"]'><div class="option">R√≠o Ebro üåä</div><div class="option">R√≠o Jarama üèûÔ∏è</div><div class="option">R√≠o Guadalquivir üçä</div><div class="option">R√≠o Manzanares üèôÔ∏è</div></div></div>
                     <div class="question" data-question-type="multiple-choice"><div class="question-text">23. ¬øCu√°les de estos r√≠os pertenecen a la vertiente atl√°ntica?</div><div class="options multiple-choice" data-correct='["Tajo üèûÔ∏è","Guadiana ü¶Ü"]'><div class="option">Tajo üèûÔ∏è</div><div class="option">Ebro üåä</div><div class="option">J√∫car üçä</div><div class="option">Guadiana ü¶Ü</div></div></div>
                     <div class="question" data-question-type="multiple-choice"><div class="question-text">24. ¬øQu√© dos fen√≥menos principales se producen en las aguas marinas?</div><div class="options multiple-choice" data-correct='["Las corrientes üåä","Las mareas üåï"]'><div class="option">Las corrientes üåä</div><div class="option">Los afluentes üèûÔ∏è</div><div class="option">Las mareas üåï</div><div class="option">Los meandros ÍµΩÏù¥</div></div></div>
                </div>

                <div class="question-section">
                    <h2>üßê Elige la frase correcta o incorrecta</h2>
                    <!-- Preguntas 25-28 -->
                    <div class="question" data-question-type="type-1"><div class="question-text">25. Elige la afirmaci√≥n CORRECTA sobre los r√≠os.</div><div class="options" data-correct="El recorrido que hace un r√≠o se llama curso. üèûÔ∏è"><div class="option">Todos los r√≠os son de agua salada. üßÇ</div><div class="option">La cantidad de agua que lleva un r√≠o se llama longitud. üìè</div><div class="option">El recorrido que hace un r√≠o se llama curso. üèûÔ∏è</div><div class="option">Los r√≠os siempre nacen en el mar. üåä</div></div></div>
                    <div class="question" data-question-type="type-1"><div class="question-text">26. Elige la afirmaci√≥n INCORRECTA sobre el ciclo del agua.</div><div class="options" data-correct="La lluvia se forma por la evaporaci√≥n directa del mar. üåä"><div class="option">La nieve es una forma de precipitaci√≥n. üå®Ô∏è</div><div class="option">El sol calienta el agua y provoca la evaporaci√≥n. ‚òÄÔ∏è</div><div class="option">La lluvia se forma por la evaporaci√≥n directa del mar. üåä</div><div class="option">Las nubes se forman por condensaci√≥n. ‚òÅÔ∏è</div></div></div>
                    <div class="question" data-question-type="type-1"><div class="question-text">27. Elige la afirmaci√≥n CORRECTA.</div><div class="options" data-correct="El caudal es la cantidad de agua y el r√©gimen es c√≥mo var√≠a esa cantidad. üìä"><div class="option">Un r√≠o con r√©gimen irregular siempre lleva la misma agua. ‚ÜîÔ∏è</div><div class="option">El caudal es el lugar por donde pasa el r√≠o. üèûÔ∏è</div><div class="option">El caudal es la cantidad de agua y el r√©gimen es c√≥mo var√≠a esa cantidad. üìä</div><div class="option">Un afluente es un r√≠o que desemboca en el mar. üåä</div></div></div>
                    <div class="question" data-question-type="type-1"><div class="question-text">28. Elige la afirmaci√≥n INCORRECTA.</div><div class="options" data-correct="Las aguas superficiales son las que est√°n bajo tierra, como los acu√≠feros.  –ø–æ–¥–∑–µ–º–Ω—ã–π"><div class="option">Los r√≠os y lagos son aguas superficiales. üèûÔ∏è</div><div class="option">Los mares y oc√©anos son masas de agua salada. üßÇ</div><div class="option">Las aguas superficiales son las que est√°n bajo tierra, como los acu√≠feros.  –ø–æ–¥–∑–µ–º–Ω—ã–π</div><div class="option">Las aguas subterr√°neas se pueden extraer con pozos. üï≥Ô∏è</div></div></div>
                </div>

                <!-- NUEVA SECCI√ìN: Emparejar -->
                <div class="question-section">
                    <h2>ü§ù Empareja las columnas</h2>
                    <div class="question" data-question-type="matching">
                        <div class="question-text">29. Empareja cada r√≠o con su vertiente hidrogr√°fica (el mar donde desemboca).</div>
                        <div class="matching-container">
                            <div class="column" id="column-a-1">
                                <div class="match-item" data-match-id="1">R√≠o Duero üáµüáπ</div>
                                <div class="match-item" data-match-id="2">R√≠o Nal√≥n üèûÔ∏è</div>
                                <div class="match-item" data-match-id="3">R√≠o Segura üçã</div>
                            </div>
                            <div class="column" id="column-b-1">
                                <div class="match-item" data-match-id="2">Vertiente Cant√°brica üåä</div>
                                <div class="match-item" data-match-id="3">Vertiente Mediterr√°nea ‚òÄÔ∏è</div>
                                <div class="match-item" data-match-id="1">Vertiente Atl√°ntica ‚õµ</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- NUEVA SECCI√ìN: Arrastrar a categor√≠a -->
                <div class="question-section">
                    <h2>üóÇÔ∏è Arrastra cada r√≠o a su vertiente</h2>
                    <div class="question" data-question-type="drag-category">
                        <div class="question-text">30. Arrastra cada r√≠o a la vertiente correcta.</div>
                        <div class="word-bank">
                            <div class="word" draggable="true" data-type="atlantica">Mi√±o üèûÔ∏è</div>
                            <div class="word" draggable="true" data-type="mediterranea">J√∫car üçä</div>
                            <div class="word" draggable="true" data-type="cantabrica">Nervi√≥n üåâ</div>
                            <div class="word" draggable="true" data-type="atlantica">Tajo üèûÔ∏è</div>
                            <div class="word" draggable="true" data-type="mediterranea">Ebro üåä</div>
                            <div class="word" draggable="true" data-type="cantabrica">Bidasoa üèûÔ∏è</div>
                            <div class="word" draggable="true" data-type="mediterranea">Llobregat üåá</div>
                            <div class="word" draggable="true" data-type="atlantica">Guadiana ü¶Ü</div>
                            <div class="word" draggable="true" data-type="cantabrica">Eo üõ∂</div>
                        </div>
                        <div class="category-container">
                            <div class="category-box">
                                <h4>Vertiente Atl√°ntica ‚õµ</h4>
                                <div class="drop-zone" data-accept="atlantica"></div>
                            </div>
                            <div class="category-box">
                                <h4>Vertiente Cant√°brica üåä</h4>
                                <div class="drop-zone" data-accept="cantabrica"></div>
                            </div>
                            <div class="category-box">
                                <h4>Vertiente Mediterr√°nea ‚òÄÔ∏è</h4>
                                <div class="drop-zone" data-accept="mediterranea"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </form>
            <button type="submit" form="quiz-form" class="submit-btn">¬°Terminar y Corregir!</button>
            <div class="results" id="results-container"></div>
        </div>
    </div>
    <footer class="main-footer">
        <a href="index.html">üîô Volver al men√∫ de materias</a>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('quiz-form');
        const resultsContainer = document.getElementById('results-container');
        const TOTAL_QUESTIONS = 30;

        // --- Event Listeners ---
        form.addEventListener('click', handleOptionClick);
        form.addEventListener('submit', handleSubmit);
        setupDragAndDrop();
        setupMatching();
        
        function handleOptionClick(e) {
            if (e.target.classList.contains('option')) {
                const optionsContainer = e.target.parentElement;
                if (optionsContainer.classList.contains('multiple-choice')) {
                    e.target.classList.toggle('selected');
                } else {
                    optionsContainer.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
                    e.target.classList.add('selected');
                }
            }
        }

        function setupDragAndDrop() {
            const words = document.querySelectorAll('.word');
            const dropZones = document.querySelectorAll('.drop-zone');
            let draggedWord = null;

            words.forEach(word => {
                word.addEventListener('dragstart', e => {
                    draggedWord = e.target;
                    setTimeout(() => e.target.style.display = 'none', 0);
                });
                word.addEventListener('dragend', e => {
                    setTimeout(() => {
                        if (draggedWord) draggedWord.style.display = 'inline-block';
                        draggedWord = null;
                    }, 0);
                });
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', e => {
                    e.preventDefault();
                    zone.classList.add('over');
                });
                zone.addEventListener('dragleave', () => zone.classList.remove('over'));
                zone.addEventListener('drop', e => {
                    e.preventDefault();
                    if (draggedWord && (zone.parentElement.classList.contains('category-box') || zone.closest('[data-question-type="drag-sort"]'))) {
                       zone.appendChild(draggedWord);
                    }
                    zone.classList.remove('over');
                });
            });
        }
        
        function setupMatching() {
            const matchingContainers = document.querySelectorAll('.matching-container');
            matchingContainers.forEach(container => {
                let selectedItem = null;
                container.addEventListener('click', e => {
                    if (!e.target.classList.contains('match-item') || e.target.classList.contains('paired')) return;

                    const currentColumn = e.target.parentElement;
                    
                    if (!selectedItem) {
                        // First selection
                        container.querySelectorAll('.match-item').forEach(item => item.classList.remove('selected'));
                        e.target.classList.add('selected');
                        selectedItem = e.target;
                    } else {
                        // Second selection (must be in a different column)
                        if (selectedItem.parentElement !== currentColumn) {
                            const id1 = selectedItem.dataset.matchId;
                            const id2 = e.target.dataset.matchId;
                            
                            // Mark as paired
                            selectedItem.classList.add('paired');
                            e.target.classList.add('paired');
                            
                            // Add pairing info for correction
                            selectedItem.dataset.pairedWith = id2;
                            e.target.dataset.pairedWith = id1;

                            selectedItem.classList.remove('selected');
                            selectedItem = null;
                        }
                    }
                });
            });
        }


        function handleSubmit(e) {
            e.preventDefault();
            calculateAndShowResults();
            highlightAnswers();
            const submitButton = document.querySelector('button[type="submit"][form="quiz-form"]');
            if(submitButton) submitButton.style.display = 'none';
        }

        function calculateAndShowResults() {
            let score = 0;

            // Single Choice
            document.querySelectorAll('[data-question-type="type-1"]').forEach(q => {
                const selected = q.querySelector('.option.selected');
                if (selected && selected.textContent.trim() === q.querySelector('.options').dataset.correct.trim()) score++;
            });
            
            // Drag and Sort
            document.querySelectorAll('[data-question-type="drag-sort"]').forEach(q => {
                 const dropZone = q.querySelector('.drop-zone');
                 const userAnswer = Array.from(dropZone.querySelectorAll('.word')).map(w => w.textContent.trim()).join(' ');
                 if(userAnswer === dropZone.dataset.answer.trim()) score++;
            });

            // Multiple Choice
            document.querySelectorAll('[data-question-type="multiple-choice"]').forEach(q => {
                const correctAnswers = JSON.parse(q.querySelector('.options').dataset.correct);
                const selectedAnswers = Array.from(q.querySelectorAll('.option.selected')).map(opt => opt.textContent.trim());
                if (selectedAnswers.length === correctAnswers.length && selectedAnswers.every(a => correctAnswers.includes(a))) score++;
            });
            
            // Matching
            document.querySelectorAll('[data-question-type="matching"]').forEach(q => {
                let correctPairs = 0;
                const items = q.querySelectorAll('.match-item[data-paired-with]');
                const totalPairs = items.length / 2;
                items.forEach(item => {
                    if (item.dataset.matchId === item.dataset.pairedWith) {
                        correctPairs++;
                    }
                });
                // Only full score if all pairs are correct
                if (totalPairs > 0 && correctPairs / 2 === totalPairs) {
                    score++;
                }
            });
            
            // Drag to Category
            document.querySelectorAll('[data-question-type="drag-category"]').forEach(q => {
                let allCorrect = true;
                q.querySelectorAll('.drop-zone').forEach(zone => {
                    const acceptedType = zone.dataset.accept;
                    zone.querySelectorAll('.word').forEach(word => {
                        if (word.dataset.type !== acceptedType) allCorrect = false;
                    });
                });
                // Check if all words from the bank are placed
                const bank = q.querySelector('.word-bank');
                if (bank.children.length > 0) allCorrect = false;

                if (allCorrect) score++;
            });

            const finalScore = (score / TOTAL_QUESTIONS) * 10;
            let feedbackMessage = '';
            
            if (finalScore >= 9) feedbackMessage = "¬°Excelente! ü•≥ ¬°Eres un verdadero experto/a en el ciclo del agua!";
            else if (finalScore >= 7) feedbackMessage = "¬°Muy bien! üëç Sigue as√≠, vas por un camino genial.";
            else if (finalScore >= 5) feedbackMessage = "¬°Aprobado! üòä Has hecho un buen trabajo, pero puedes mejorar un poco.";
            else feedbackMessage = "üí© ¬°Oh, no! Necesitas repasar un poco m√°s. ¬°No te rindas, t√∫ puedes!";

            resultsContainer.innerHTML = `<p>Tu puntuaci√≥n final es:</p><p class="final-score">${finalScore.toFixed(2)} / 10</p><p class="feedback-message">${feedbackMessage}</p>`;
            resultsContainer.classList.add('show');
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function highlightAnswers() {
            // Disable all interactions
            form.style.pointerEvents = 'none';

            // Single Choice
            document.querySelectorAll('[data-question-type="type-1"]').forEach(q => {
                const correctAnsw = q.querySelector('.options').dataset.correct.trim();
                q.querySelectorAll('.option').forEach(opt => {
                    if (opt.textContent.trim() === correctAnsw) opt.classList.add('correct');
                    else if (opt.classList.contains('selected')) opt.classList.add('incorrect');
                });
            });
            
            // Drag and Sort
            document.querySelectorAll('[data-question-type="drag-sort"]').forEach(q => {
                 const dropZone = q.querySelector('.drop-zone');
                 const userAnswer = Array.from(dropZone.querySelectorAll('.word')).map(w => w.textContent.trim()).join(' ');
                 dropZone.classList.add(userAnswer === dropZone.dataset.answer.trim() ? 'correct' : 'incorrect');
            });

            // Multiple Choice
            document.querySelectorAll('[data-question-type="multiple-choice"]').forEach(q => {
                const correctAnswers = JSON.parse(q.querySelector('.options').dataset.correct);
                q.querySelectorAll('.option').forEach(opt => {
                    if (correctAnswers.includes(opt.textContent.trim())) opt.classList.add('correct');
                    else if (opt.classList.contains('selected')) opt.classList.add('incorrect');
                });
            });
            
            // Matching
            document.querySelectorAll('[data-question-type="matching"] .match-item[data-paired-with]').forEach(item => {
                item.classList.add(item.dataset.matchId === item.dataset.pairedWith ? 'paired-correct' : 'paired-incorrect');
            });

            // Drag to Category
            document.querySelectorAll('[data-question-type="drag-category"] .drop-zone').forEach(zone => {
                const acceptedType = zone.dataset.accept;
                zone.querySelectorAll('.word').forEach(word => {
                    word.classList.add(word.dataset.type === acceptedType ? 'correct' : 'incorrect');
                });
            });
        }
    });
    </script>
</body>
</html>
